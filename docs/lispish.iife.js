var Lispish=function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var r=function(e,n){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])},r(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function t(){this.constructor=e}r(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}var t=function(){return t=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var a in r=arguments[n])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},t.apply(this,arguments)};function a(e,r){for(var n=0,t=r.length,a=e.length;n<t;n++,a++)e[a]=r[n];return e}var u=function(e){function r(n){var t=e.call(this,"recur, params: "+n)||this;return Object.setPrototypeOf(t,r.prototype),t.name="RecurSignal",t.params=n,t}return n(r,e),r}(Error),i=function(e){function r(n){var t=e.call(this,n)||this;return Object.setPrototypeOf(t,r.prototype),t.name="UserDefinedError",t}return n(r,e),r}(Error),o=function(e){function r(n){var t=e.call(this,"Assertion error: "+n)||this;return Object.setPrototypeOf(t,r.prototype),t.name="AssertionError",t}return n(r,e),r}(Error),f=function(e){function r(n,t){var a=e.call(this,'Expected a "'+n+'" token, got Token['+t.type+':"'+t.value+'"]')||this;return Object.setPrototypeOf(a,r.prototype),a.name="UnexpectedTokenError",a}return n(r,e),r}(Error),l=function(e){function r(n,t){var a=e.call(this,"Expected a "+n+" node, got "+(t?"a "+t.type+" node":"undefined"))||this;return Object.setPrototypeOf(a,r.prototype),a.name="UnexpectedNodeTypeError",a}return n(r,e),r}(Error),c=Symbol("function");function v(e){if(void 0===e)throw Error("Expected an AST node, got undefined");return e}function s(e){if(void 0===e||"Name"!==e.type)throw new l("Name",e)}function p(e,r){if(void 0===r&&(r="Unexpected end of input"),void 0===e)throw Error(r);return e}function d(e){if("number"!=typeof e||!isFinite(e))throw TypeError("Expected number, got: "+e+' type="'+typeof e+'"')}function h(e){!function(e){if(d(e),e<0)throw TypeError("Expected non negative number, got "+e)}(e),m(e)}function m(e){if(d(e),!Number.isInteger(e))throw TypeError("Expected integer, got "+e)}function g(e,r){if(d(e),e<r)throw TypeError("Expected parameter ("+e+") to be a number equal or grater than "+r)}function y(e){if("string"!=typeof e)throw TypeError("Expected string, got: "+e+' type="'+typeof e+'"')}function b(e){if(y(e),1!==e.length)throw TypeError("Expected char, got: "+e+' type="'+typeof e+'"')}function E(e){if("string"!=typeof e&&"number"!=typeof e)throw TypeError("Expected string or number, got: "+e+' type="'+typeof e+'"')}function x(e){if(!(e instanceof RegExp))throw TypeError("Expected RegExp, got: "+e+' type="'+typeof e+'"')}function w(e,r){var n=r.params.length;if("number"==typeof e){if(n!==e)throw Error('Wrong number of arguments to "'+r.name+'", expected '+e+", got "+n)}else{var t=e.min,a=e.max;if(void 0===t&&void 0===a)throw Error("Min or max must be specified");if("number"==typeof t&&n<t)throw Error('Wrong number of arguments to "'+r.name+'", expected at least '+t+", got "+n);if("number"==typeof a&&n>a)throw Error('Wrong number of arguments to "'+r.name+'", expected at most '+a+", got "+n)}}function A(e){var r=e.params.length;if(r%2!=0)throw Error("Wrong number of arguments, expected an even number, got "+r)}function N(e){return null!==e&&"object"==typeof e&&!!e[c]}function j(e){if(null===e||"object"!=typeof e)throw Error("Expected lispish function, got "+e);if(!e[c])throw Error("Expected lispish function, got "+JSON.stringify(e))}function k(e){return!!N(e)&&!!e.arguments}function O(e){if(!Array.isArray(e)||e.some((function(e){return"string"!=typeof e||1!==e.length})))throw Error("Expected an array of chars, got "+e)}function M(e){if(!q(e))throw TypeError("Expected a number, got: "+e+' type="'+typeof e+'"')}function S(e){if(!R(e))throw TypeError("Expected Arr, got: "+e+' type="'+typeof e+'"')}function T(e){if(!C(e))throw TypeError("Expected collection, got: "+e+' type="'+typeof e+'"')}function I(e){if(!L(e))throw TypeError("Expected string or array, got: "+e+' type="'+typeof e+'"')}function F(e){if(!P(e))throw TypeError("Expected object, got: "+e+' type="'+typeof e+'"')}function P(e){return!(null===e||"object"!=typeof e||Array.isArray(e)||e instanceof RegExp||N(e))}function R(e){return Array.isArray(e)}function L(e){return Array.isArray(e)||_(e)}function C(e){return L(e)||P(e)}function _(e){return"string"==typeof e}function q(e){return"number"==typeof e}function U(e){return Number.isInteger(e)}function V(e,r){return!!C(e)&&(_(e)||R(e)?!!U(r)&&(r>=0&&r<e.length):!!Object.getOwnPropertyDescriptor(e,r))}var $={boolean:0,number:1,string:2,array:3,object:4,regexp:5,unknown:6,null:7,undefined:8};function D(e){return void 0===e?"undefined":null===e?"null":"boolean"==typeof e?"boolean":"number"==typeof e?"number":"string"==typeof e?"string":R(e)?"array":P(e)?"object":function(e){return e instanceof RegExp}(e)?"regexp":"unknown"}function z(e,r){var n=D(e),t=D(r);if(n!==t)return Math.sign($[n]-$[t]);switch(n){case"undefined":case"null":case"unknown":return 0;case"boolean":return e===r?0:!1===e?-1:1;case"number":return Math.sign(e-r);case"string":return(c=e)<(v=r)?-1:c>v?1:0;case"array":var a=e,u=r;if(a.length<u.length)return-1;if(a.length>u.length)return 1;for(var i=0;i<a.length;i+=1){var o=z(a[i],u[i]);if(0!==o)return o}return 0;case"object":var f=e,l=r;return Math.sign(Object.keys(f).length-Object.keys(l).length);case"regexp":var c,v;return(c=e.source)<(v=r.source)?-1:c>v?1:0}}var B={parse:function(e,r,n){var t;return t=function(e,r,n){for(var t,a,u=[],i=p(e[r]);"paren"!==i.type||")"!==i.value;){var o,f;r=(t=n(e,r))[0],o=t[1],r=(a=n(e,r))[0],f=a[1],u.push({test:o,form:f}),i=p(e[r])}return[r,u]}(e,r,n.parseToken),[(r=t[0])+1,{type:"SpecialExpression",name:"cond",conditions:t[1],params:[]}]},evaluate:function(e,r,n){for(var t=n.evaluateAstNode,a=0,u=e.conditions;a<u.length;a++){var i=u[a];if(t(i.test,r))return t(i.form,r)}}},G={true:{value:!0},false:{value:!1},null:{value:null},undefined:{value:void 0}},W=Object.keys(G);function J(e,r,n){if("string"==typeof e){if(n.specialExpressions[e])throw Error("Cannot define variable "+e+", it's a special expression");if(n.normalExpressions[e])throw Error("Cannot define variable "+e+", it's a builtin function");if(G[e])throw Error("Cannot define variable "+e+", it's a reserved name");if(p(r[r.length-2])[e])throw Error('Name already defined "'+e+'"')}}function K(e){return function(r,n,t){var a,u=t.parseToken,i=t.parseArgument,o=t.parseBindings,c=void 0;if(("defn"===e||"defns"===e)&&(n=(a=u(r,n))[0],c=a[1],"defn"===e&&"Name"!==c.type))throw new l("Name",c);for(var v=function(e,r,n,t){var a,u=[],i=void 0,o=[],l=[],c={},v="mandatory",s=p(e[r]);if("paren"!==s.type||"["!==s.value)throw new f("[",s);for(s=p(e[r+=1]);"paren"!==s.type||"]"!==s.value;){if("bind"===v){r=(a=t(e,r))[0],u=a[1];break}var d=n(e,r),h=d[0],m=d[1];if(s=p(e[r=h]),"Modifier"===m.type)switch(m.value){case"&opt":if("rest"===v)throw Error("&opt cannot appear after &rest");if("optional"===v)throw Error("&opt can only appear once");v="optional";break;case"&rest":if("rest"===v)throw Error("&rest can only appear once");if("optional"===v&&0===l.length)throw Error("No optional arguments where spcified");v="rest";break;case"&bind":if("optional"===v&&0===l.length)throw Error("No optional arguments where spcified");if("rest"===v&&!i)throw Error("No rest argument was spcified");v="bind"}else{if(c[m.name])throw Error('Duplicate argument "'+m.name+'"');if(c[m.name]=!0,Object.getOwnPropertyDescriptor(m,"defaultValue")){if("optional"!==v)throw Error("Cannot specify default value if not an optional argument");l.push({name:m.name,defaultValue:m.defaultValue})}else switch(v){case"mandatory":o.push(m.name);break;case"optional":l.push({name:m.name,defaultValue:void 0});break;case"rest":if(void 0!==i)throw Error("Can only specify one rest argument");i=m.name}}}if("rest"===v&&void 0===i)throw Error("Missing rest argument name");if("optional"===v&&0===l.length)throw Error("No optional arguments where spcified");return[r+=1,{mandatoryArguments:o,optionalArguments:l,restArgument:i,bindings:u}]}(r,n,i,o),s=v[0],d=v[1],h=p(r[n=s]),m=[];"paren"!==h.type||")"!==h.value;){var g=u(r,n),y=g[0],b=g[1];m.push(b),h=p(r[n=y])}if(0===m.length)throw Error('Missing body in special expression "defn"');return n+=1,"defn"===e||"defns"===e?[n,{type:"SpecialExpression",name:e,functionName:c,params:[],arguments:d,body:m}]:[n,{type:"SpecialExpression",name:e,params:[],arguments:d,body:m}]}}function Y(e){return function(r,n,t){var a,u=t.evaluateAstNode,i=t.builtin,o=function(e,r,n,t){if("defn"===e){var a=r.functionName.value;return y(a),a}if("defns"===e){var u=t(r.functionName,n);return y(u),u}}(e,r,n,u);J(o,n,i);for(var f={},l=0,v=r.arguments.bindings;l<v.length;l++){var s=v[l],d=s.value,h=u(d,n);f[s.name]={value:h}}var m=r.arguments.optionalArguments.map((function(e){var r=e.name,t=e.defaultValue;return t?{name:r,defaultValue:u(t,n)}:{name:r}})),g=((a={})[c]=!0,a.name=o,a.arguments={mandatoryArguments:r.arguments.mandatoryArguments,restArgument:r.arguments.restArgument,optionalArguments:m},a.body=r.body,a.functionContext=f,a);if("fn"===e)return g;p(n[n.length-2],"Could not find global scope")[o]={value:g}}}var H={parse:K("defn"),evaluate:Y("defn")},X={parse:K("defns"),evaluate:Y("defns")},Z={parse:K("fn"),evaluate:Y("fn")},Q={parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"if",params:t[1]}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=e.params,u=a[0],i=a[1],o=a[2];return t(v(u),r)?t(v(i),r):3===e.params.length?t(v(o),r):void 0},validate:function(e){return w({min:2,max:3},e)}},ee={parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"if-not",params:t[1]}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=e.params,u=a[0],i=a[1],o=a[2];return t(v(u),r)?3===e.params.length?t(v(o),r):void 0:t(v(i),r)},validate:function(e){return w({min:2,max:3},e)}},re={parse:function(e,r,n){var t,a,u,i=n.parseBindings,o=n.parseTokens;return r=(t=i(e,r))[0],u=t[1],[(r=(a=o(e,r))[0])+1,{type:"SpecialExpression",name:"let",params:a[1],bindings:u}]},evaluate:function(e,r,n){for(var t=n.evaluateAstNode,u={},i=0,o=e.bindings;i<o.length;i++){var f=o[i],l=t(f.value,r);if(N(l))throw Error("Cannot bind function in let expression");u[f.name]={value:l}}for(var c,v=a([u],r),s=0,p=e.params;s<p.length;s++){c=t(p[s],v)}return c}},ne={parse:function(e,r,n){for(var t=n.parseToken,a={type:"SpecialExpression",name:"do",params:[]},u=p(e[r]);"paren"!==u.type||")"!==u.value;){var i=t(e,r),o=i[0],f=i[1];a.params.push(f),u=p(e[r=o])}return[r+1,a]},evaluate:function(e,r,n){for(var t,u=n.evaluateAstNode,i=a([{}],r),o=0,f=e.params;o<f.length;o++){t=u(f[o],i)}return t}},te={parse:function(e,r,n){var t=(0,n.parseTokens)(e,r),a=t[0],u=t[1];return s(u[0]),[a+1,{type:"SpecialExpression",name:"def",params:u}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=n.builtin,u=function(e){if(void 0===e||"Name"!==e.type)throw new l("Name",e);return e}(e.params[0]).value;J(u,r,a);var i=t(v(e.params[1]),r);return p(r[r.length-2])[u]={value:i},i},validate:function(e){return w(2,e)}},ae={parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"defs",params:t[1]}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=n.builtin,u=t(v(e.params[0]),r);y(u),J(u,r,a);var i=t(v(e.params[1]),r);return p(r[r.length-2])[u]={value:i},i},validate:function(e){return w(2,e)}},ue={parse:function(e,r,n){var t=(0,n.parseToken)(e,r),a=t[0],u=t[1],i=p(e[r=a]);if("paren"!==i.type||")"!==i.value)throw new f(")",i);return[r+=1,{type:"SpecialExpression",name:"throw",params:[],messageNode:u}]},evaluate:function(e,r,n){var t=function(e){if("string"!=typeof e||0===e.length)throw TypeError("Expected non empty string, got: "+e+' type="'+typeof e+'"');return e}((0,n.evaluateAstNode)(e.messageNode,r));throw new i(t)}},ie={parse:function(e,r,n){var t,a,u,i,o=n.parseToken;r=(t=o(e,r))[0],i=t[1];var c,v,s=p(e[r]);if("paren"!==s.type||"("!==s.value)throw new f("(",s);if("paren"!==(s=p(e[r+=1])).type||"("!==s.value)throw new f("(",s);if(r=(a=o(e,r+=1))[0],"Name"!==(c=a[1]).type)throw new l("Name",c);if("paren"!==(s=p(e[r])).type||")"!==s.value)throw new f(")",s);if(r=(u=o(e,r+=1))[0],v=u[1],"paren"!==(s=p(e[r])).type||")"!==s.value)throw new f(")",s);if("paren"!==(s=p(e[r+=1])).type||")"!==s.value)throw new f(")",s);return[r+=1,{type:"SpecialExpression",name:"try",params:[],tryExpression:i,catchExpression:v,error:c}]},evaluate:function(e,r,n){var t,u=n.evaluateAstNode;try{return u(e.tryExpression,r)}catch(n){var i=((t={})[e.error.value]={value:n},t);return u(e.catchExpression,a([i],r))}}},oe={parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"when",params:t[1]}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=e.params,u=a[0],i=a.slice(1);if(function(e,r){if(void 0===r&&(r="Unexpected end of input"),void 0===e)throw Error(r)}(u),t(u,r)){for(var o=void 0,f=0,l=i;f<l.length;f++){o=t(l[f],r)}return o}},validate:function(e){return w({min:1},e)}},fe={parse:function(e,r,n){var t;return[(r=(t=(0,n.parseTokens)(e,r))[0])+1,{type:"SpecialExpression",name:"recur",params:t[1]}]},evaluate:function(e,r,n){var t=n.evaluateAstNode,a=e.params.map((function(e){return t(e,r)}));throw new u(a)}},le={parse:function(e,r,n){var t,a,u,i=n.parseTokens;return r=(t=(0,n.parseBindings)(e,r))[0],u=t[1],[(r=(a=i(e,r))[0])+1,{type:"SpecialExpression",name:"loop",params:a[1],bindings:u}]},evaluate:function(e,r,n){for(var t=n.evaluateAstNode,i=e.bindings.reduce((function(e,n){return e[n.name]={value:t(n.value,r)},e}),{}),o=a([i],r),f=function(){var r=void 0;try{for(var n=0,a=e.params;n<a.length;n++){var f=a[n];r=t(f,o)}}catch(r){if(r instanceof u){var l=r.params;if(l.length!==e.bindings.length)throw Error("recur expected "+e.bindings.length+" parameters, got "+l.length);return e.bindings.forEach((function(e,r){p(i[e.name]).value=l[r]})),"continue"}throw r}return{value:r}};;){var l=f();if("object"==typeof l)return l.value}}},ce={get:{evaluate:function(e){var r=e[0],n=e[1],t=e[2],a=3===e.length;if(T(r),R(r)){if(m(n),n<r.length)return r[n]}else{if(!P(r))return m(n),r[n];if(y(n),Object.getOwnPropertyDescriptor(r,n))return r[n]}if(a)return t},validate:function(e){return w({min:2,max:3},e)}},count:{evaluate:function(e){var r=e[0];return"string"==typeof r?r.length:(T(r),Array.isArray(r)?r.length:Object.keys(r).length)},validate:function(e){return w(1,e)}},"contains?":{evaluate:function(e){var r=e[0],n=e[1];return T(r),E(n),Array.isArray(r)?!!Number.isInteger(n)&&(m(n),n>=0&&n<r.length):"string"==typeof n&&!!Object.getOwnPropertyDescriptor(r,n)},validate:function(e){return w(2,e)}},assoc:{evaluate:function(e){var r=e[0],n=e[1],u=e[2];if(T(r),E(n),Array.isArray(r)||"string"==typeof r){if(m(n),g(n,0),function(e,r){if(d(e),e>r)throw TypeError("Expected parameter ("+e+") to be a number equal or less than "+r)}(n,r.length),"string"==typeof r)return b(u),""+r.slice(0,n)+u+r.slice(n+1);var i=a([],r);return i[n]=u,i}y(n);var o=t({},r);return o[n]=u,o},validate:function(e){return w(3,e)}},concat:{evaluate:function(e){return T(e[0]),R(e[0])?e.reduce((function(e,r){return S(r),e.concat(r)}),[]):_(e[0])?e.reduce((function(e,r){return y(r),""+e+r}),""):e.reduce((function(e,r){return F(r),Object.assign(e,r)}),{})},validate:function(e){return w({min:1},e)}},"empty?":{evaluate:function(e){var r=e[0];return T(r),_(r)||Array.isArray(r)?0===r.length:0===Object.keys(r).length},validate:function(e){return w(1,e)}}},ve={array:{evaluate:function(e){return e}},range:{evaluate:function(e){var r,n,t,a=e[0],u=e[1],i=e[2];d(a),1===e.length?(r=0,t=(n=a)>=0?1:-1):2===e.length?(d(u),t=(n=u)>=(r=a)?1:-1):(d(u),d(i),t=i,(n=u)>(r=a)?function(e){if(d(e),e<=0)throw TypeError("Expected positive number, got "+e)}(t):n<r?function(e){if(d(e),e>=0)throw TypeError("Expected negative number, got "+e)}(t):function(e){if(d(e),0===e)throw TypeError("Expected non zero value")}(t));for(var o=[],f=r;t<0?f>n:f<n;f+=t)o.push(f);return o},validate:function(e){return w({min:1,max:3},e)}},repeat:{evaluate:function(e){var r=e[0],n=e[1];h(r);for(var t=[],a=0;a<r;a+=1)t.push(n);return t},validate:function(e){return w(2,e)}}},se={cons:{evaluate:function(e){var r=e[0],n=e[1];return I(n),Array.isArray(n)?a([r],n):(b(r),""+r+n)},validate:function(e){return w(2,e)}},nth:{evaluate:function(e){var r=e[0],n=e[1];return I(r),m(n),r[n]},validate:function(e){return w(2,e)}},"every?":{evaluate:function(e,r,n){var t=e[0],a=e[1],u=n.evaluateLispishFunction;return j(t),I(a),0!==a.length&&(Array.isArray(a)?a.every((function(e){return u(t,[e],r)})):a.split("").every((function(e){return u(t,[e],r)})))},validate:function(e){return w(2,e)}},filter:{evaluate:function(e,r,n){var t=e[0],a=e[1],u=n.evaluateLispishFunction;return j(t),I(a),Array.isArray(a)?a.filter((function(e){return u(t,[e],r)})):a.split("").filter((function(e){return u(t,[e],r)})).join("")},validate:function(e){return w(2,e)}},first:{evaluate:function(e){var r=e[0];return I(r),r[0]},validate:function(e){return w(1,e)}},last:{evaluate:function(e){var r=e[0];return I(r),r[r.length-1]},validate:function(e){return w(1,e)}},map:{evaluate:function(e,r,n){var t=n.evaluateLispishFunction,a=e[0],u=e[1];j(a),I(u);var i=_(u),o=u.length;if(2===e.length)return R(u)?u.map((function(e){return t(a,[e],r)})):u.split("").map((function(e){var n=t(a,[e],r);return b(n),n})).join("");if(e.slice(2).forEach((function(e){if(i?y(e):S(e),o!==e.length)throw Error('All arguments to "map" must have the same length')})),i){for(var f="",l=function(n){var u=e.slice(1).map((function(e){return e[n]})),i=t(a,u,r);b(i),f+=i},c=0;c<o;c+=1)l(c);return f}f=[];var v=function(n){var u=e.slice(1).map((function(e){return e[n]}));f.push(t(a,u,r))};for(c=0;c<o;c+=1)v(c);return f},validate:function(e){return w({min:2},e)}},pop:{evaluate:function(e){var r=e[0];if(I(r),_(r))return r.substr(0,r.length-1);var n=a([],r);return n.pop(),n},validate:function(e){return w(1,e)}},position:{evaluate:function(e,r,n){var t,a=e[0],u=e[1],i=n.evaluateLispishFunction;return j(a),I(u),_(u)?-1!==(t=u.split("").findIndex((function(e){return i(a,[e],r)})))?t:void 0:-1!==(t=u.findIndex((function(e){return i(a,[e],r)})))?t:void 0},validate:function(e){return w(2,e)}},"index-of":{evaluate:function(e){var r,n=e[0],t=e[1];return I(n),_(n)?(y(t),-1!==(r=n.indexOf(t))?r:void 0):-1!==(r=n.indexOf(t))?r:void 0},validate:function(e){return w(2,e)}},push:{evaluate:function(e){var r=e[0],n=e.slice(1);return I(r),_(r)?(O(n),a([r],n).join("")):a(a([],r),n)},validate:function(e){return w({min:2},e)}},reduce:{evaluate:function(e,r,n){var t=n.evaluateLispishFunction,a=e[0];if(j(a),2===e.length){var u=e[1];if(I(u),0===u.length)return t(a,[],r);if(1===u.length)return u[0];if(_(u)){var i=u.split("");return i.slice(1).reduce((function(e,n){return t(a,[e,n],r)}),i[0])}return u.slice(1).reduce((function(e,n){return t(a,[e,n],r)}),u[0])}var o=e[1],f=e[2];return I(f),_(f)?(y(o),0===f.length?o:f.split("").reduce((function(e,n){return t(a,[e,n],r)}),o)):0===f.length?o:f.reduce((function(e,n){return t(a,[e,n],r)}),o)},validate:function(e){return w({min:2,max:3},e)}},"reduce-right":{evaluate:function(e,r,n){var t=n.evaluateLispishFunction,a=e[0];if(j(a),2===e.length){if(I(i=e[1]),0===i.length)return t(a,[],r);if(1===i.length)return i[0];if(_(i)){var u=i.split("");return u.slice(0,u.length-1).reduceRight((function(e,n){return t(a,[e,n],r)}),u[u.length-1])}return i.slice(0,i.length-1).reduceRight((function(e,n){return t(a,[e,n],r)}),i[i.length-1])}var i,o=e[1];return I(i=e[2]),_(i)?0===i.length?o:i.split("").reduceRight((function(e,n){return t(a,[e,n],r)}),o):0===i.length?o:i.reduceRight((function(e,n){return t(a,[e,n],r)}),o)},validate:function(e){return w({min:2,max:3},e)}},rest:{evaluate:function(e){var r=e[0];return I(r),Array.isArray(r)?r.length<=1?[]:r.slice(1):r.substr(1)},validate:function(e){return w(1,e)}},next:{evaluate:function(e){var r=e[0];if(I(r),Array.isArray(r)){if(r.length<=1)return;return r.slice(1)}if(!(r.length<=1))return r.substr(1)},validate:function(e){return w(1,e)}},reverse:{evaluate:function(e){var r=e[0];return I(r),Array.isArray(r)?a([],r).reverse():r.split("").reverse().join("")},validate:function(e){return w(1,e)}},second:{evaluate:function(e){var r=e[0];return I(r),r[1]},validate:function(e){return w(1,e)}},shift:{evaluate:function(e){var r=e[0];if(I(r),_(r))return r.substr(1);var n=a([],r);return n.shift(),n},validate:function(e){return w(1,e)}},slice:{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return I(r),1===e.length?r:(m(n),2===e.length?r.slice(n):(m(t),r.slice(n,t)))},validate:function(e){return w({min:1,max:3},e)}},some:{evaluate:function(e,r,n){var t=e[0],a=e[1],u=n.evaluateLispishFunction;if(j(t),I(a),0!==a.length)return _(a)?a.split("").find((function(e){return u(t,[e],r)})):a.find((function(e){return u(t,[e],r)}))},validate:function(e){return w(2,e)}},sort:{evaluate:function(e,r,n){var t=n.evaluateLispishFunction,u=1===e.length,i=u?e[0]:e[1],o=u?null:e[0];if(I(i),_(i)){var f=i.split("");return u?f.sort(z):(j(o),f.sort((function(e,n){var a=t(o,[e,n],r);return d(a),a}))),f.join("")}var l=a([],i);return u?l.sort(z):l.sort((function(e,n){j(o);var a=t(o,[e,n],r);return d(a),a})),l},validate:function(e){return w({min:1,max:2},e)}},take:{evaluate:function(e){var r=e[0],n=e[1];m(r),I(n);var t=Math.max(0,r);return n.slice(0,t)},validate:function(e){return w(2,e)}},"take-last":{evaluate:function(e){var r=e[0],n=e[1];I(n),h(r);var t=n.length-r;return n.slice(t)},validate:function(e){return w(2,e)}},"take-while":{evaluate:function(e,r,n){var t=e[0],a=e[1],u=n.evaluateLispishFunction;I(a),j(t);for(var i=[],o=0,f=a;o<f.length;o++){var l=f[o];if(!u(t,[l],r))break;i.push(l)}return _(a)?i.join(""):i},validate:function(e){return w(2,e)}},unshift:{evaluate:function(e){var r=e[0],n=e.slice(1);if(I(r),_(r))return O(n),a(a([],n),[r]).join("");var t=a([],r);return t.unshift.apply(t,n),t},validate:function(e){return w({min:2},e)}},"random-sample":{evaluate:function(e){var r=e[0],n=e[1];return d(r),I(n),_(n)?n.split("").filter((function(){return Math.random()<r})).join(""):n.filter((function(){return Math.random()<r}))},validate:function(e){return w(2,e)}},shuffle:{evaluate:function(e){var r=e[0];I(r);for(var n,t,u=_(r)?a([],r.split("")):a([],r),i=u.length;i;)i-=1,t=Math.floor(Math.random()*i),n=u[i],u[i]=u[t],u[t]=n;return _(r)?u.join(""):u},validate:function(e){return w(1,e)}}},pe={inc:{evaluate:function(e){var r=e[0];return M(r),r+1},validate:function(e){return w(1,e)}},dec:{evaluate:function(e){var r=e[0];return M(r),r-1},validate:function(e){return w(1,e)}},"+":{evaluate:function(e){return e.reduce((function(e,r){return M(r),e+r}),0)}},"*":{evaluate:function(e){return e.reduce((function(e,r){return M(r),e*r}),1)}},"/":{evaluate:function(e){if(0===e.length)return 1;var r=e[0],n=e.slice(1);return M(r),0===n.length?(M(r),1/r):n.reduce((function(e,r){return M(r),e/r}),r)}},"-":{evaluate:function(e){var r=e[0],n=e.slice(1);return r?(M(r),0===n.length?-r:n.reduce((function(e,r){return M(r),e-r}),r)):0}},quot:{evaluate:function(e){var r=e[0],n=e[1];return M(r),M(n),Math.trunc(r/n)},validate:function(e){return w(2,e)}},mod:{evaluate:function(e){var r=e[0],n=e[1];return M(r),M(n),r-n*Math.floor(r/n)},validate:function(e){return w(2,e)}},rem:{evaluate:function(e){var r=e[0],n=e[1];return M(r),M(n),r-n*Math.trunc(r/n)},validate:function(e){return w(2,e)}},sqrt:{evaluate:function(e){var r=e[0];return M(r),Math.sqrt(r)},validate:function(e){return w(1,e)}},cbrt:{evaluate:function(e){var r=e[0];return M(r),Math.cbrt(r)},validate:function(e){return w(1,e)}},pow:{evaluate:function(e){var r=e[0],n=e[1];return M(r),M(n),Math.pow(r,n)},validate:function(e){return w(2,e)}},round:{evaluate:function(e){var r=e[0],n=e[1];if(M(r),1===e.length||0===n)return Math.round(r);h(n);var t=Math.pow(10,n);return Math.round(r*t)/t},validate:function(e){return w({min:1,max:2},e)}},trunc:{evaluate:function(e){var r=e[0];return M(r),Math.trunc(r)},validate:function(e){return w(1,e)}},floor:{evaluate:function(e){var r=e[0];return M(r),Math.floor(r)},validate:function(e){return w(1,e)}},ceil:{evaluate:function(e){var r=e[0];return M(r),Math.ceil(r)},validate:function(e){return w(1,e)}},rand:{evaluate:function(e){var r=1===e.length?e[0]:1;return M(r),Math.random()*r},validate:function(e){return w({min:0,max:1},e)}},"rand-int":{evaluate:function(e){var r=e[0];return M(r),Math.floor(Math.random()*Math.abs(r))*Math.sign(r)},validate:function(e){return w(1,e)}},min:{evaluate:function(e){var r=e[0],n=e.slice(1);return M(r),0===n.length?r:n.reduce((function(e,r){return M(r),Math.min(e,r)}),r)},validate:function(e){return w({min:1},e)}},max:{evaluate:function(e){var r=e[0],n=e.slice(1);return M(r),0===n.length?r:n.reduce((function(e,r){return M(r),Math.max(e,r)}),r)},validate:function(e){return w({min:1},e)}},abs:{evaluate:function(e){var r=e[0];return M(r),Math.abs(r)},validate:function(e){return w(1,e)}},sign:{evaluate:function(e){var r=e[0];return M(r),Math.sign(r)},validate:function(e){return w(1,e)}},e:{evaluate:function(){return Math.E},validate:function(e){return w(0,e)}},pi:{evaluate:function(){return Math.PI},validate:function(e){return w(0,e)}},exp:{evaluate:function(e){var r=e[0];return M(r),Math.exp(r)},validate:function(e){return w(1,e)}},log:{evaluate:function(e){var r=e[0];return M(r),Math.log(r)},validate:function(e){return w(1,e)}},log2:{evaluate:function(e){var r=e[0];return M(r),Math.log2(r)},validate:function(e){return w(1,e)}},log10:{evaluate:function(e){var r=e[0];return M(r),Math.log10(r)},validate:function(e){return w(1,e)}},sin:{evaluate:function(e){var r=e[0];return M(r),Math.sin(r)},validate:function(e){return w(1,e)}},asin:{evaluate:function(e){var r=e[0];return M(r),Math.asin(r)},validate:function(e){return w(1,e)}},sinh:{evaluate:function(e){var r=e[0];return M(r),Math.sinh(r)},validate:function(e){return w(1,e)}},asinh:{evaluate:function(e){var r=e[0];return M(r),Math.asinh(r)},validate:function(e){return w(1,e)}},cos:{evaluate:function(e){var r=e[0];return M(r),Math.cos(r)},validate:function(e){return w(1,e)}},acos:{evaluate:function(e){var r=e[0];return M(r),Math.acos(r)},validate:function(e){return w(1,e)}},cosh:{evaluate:function(e){var r=e[0];return M(r),Math.cosh(r)},validate:function(e){return w(1,e)}},acosh:{evaluate:function(e){var r=e[0];return M(r),Math.acosh(r)},validate:function(e){return w(1,e)}},tan:{evaluate:function(e){var r=e[0];return M(r),Math.tan(r)},validate:function(e){return w(1,e)}},atan:{evaluate:function(e){var r=e[0];return M(r),Math.atan(r)},validate:function(e){return w(1,e)}},tanh:{evaluate:function(e){var r=e[0];return M(r),Math.tanh(r)},validate:function(e){return w(1,e)}},atanh:{evaluate:function(e){var r=e[0];return M(r),Math.atanh(r)},validate:function(e){return w(1,e)}}},de=/[[.]/;function he(e,r){for(var n=0,t=me(r);n<t.length;n++){var a=t[n];try{e=e[a]}catch(e){return}}return e}function me(e){if(!e)return[];var r=de.exec(e);if(!r)return[e];if(r.index>0)return a([e.substring(0,r.index)],me(e.substring(r.index)));if("."===e[0]){if(e.length<2)throw Error("Ill formed path: "+e);return me(e.substring(1))}var n=function(e){var r=ge.exec(e)||ye.exec(e);if(r){return[r[0].length,r[1]]}var n=be.exec(e);if(n){return[n[0].length,Number(n[1])]}throw Error("Ill formed path: "+e)}(e),t=n[0],u=n[1];if(e.length>t&&"."!==e[t]&&"["!==e[t])throw Error("Ill formed path: "+e);return a([u],me(e.substring(t)))}var ge=/^\[\s*'(.*)'\s*\]/,ye=/^\[\s*"(.*)"\s*\]/,be=/^\[\s*(\d+)\s*\]/;var Ee={"not=":{evaluate:function(e){for(var r=0;r<e.length-1;r+=1)for(var n=r+1;n<e.length;n+=1)if(e[r]===e[n])return!1;return!0},validate:function(e){return w({min:1},e)}},"=":{evaluate:function(e){for(var r=e[0],n=0,t=e.slice(1);n<t.length;n++){if(t[n]!==r)return!1}return!0},validate:function(e){return w({min:1},e)}},">":{evaluate:function(e){for(var r=e[0],n=0,t=e.slice(1);n<t.length;n++){var a=t[n];if(z(r,a)<=0)return!1;r=a}return!0},validate:function(e){return w({min:1},e)}},"<":{evaluate:function(e){for(var r=e[0],n=0,t=e.slice(1);n<t.length;n++){var a=t[n];if(z(r,a)>=0)return!1;r=a}return!0},validate:function(e){return w({min:1},e)}},">=":{evaluate:function(e){for(var r=e[0],n=0,t=e.slice(1);n<t.length;n++){var a=t[n];if(z(r,a)<0)return!1;r=a}return!0},validate:function(e){return w({min:1},e)}},"<=":{evaluate:function(e){for(var r=e[0],n=0,t=e.slice(1);n<t.length;n++){var a=t[n];if(z(r,a)>0)return!1;r=a}return!0},validate:function(e){return w({min:1},e)}},apply:{evaluate:function(e,r,n){var t=e[0],a=e[1],u=n.evaluateLispishFunction;return j(t),S(a),u(t,a,r)},validate:function(e){return w(2,e)}},"get-path":{evaluate:function(e){var r=e[0],n=e[1];return function(e){if((null===e||"object"!=typeof e||Array.isArray(e)||e instanceof RegExp||N(e))&&!Array.isArray(e))throw TypeError("Expected object or array, got: "+e+' type="'+typeof e+'"')}(r),y(n),he(r,n)},validate:function(e){return w(2,e)}},not:{evaluate:function(e){return!e[0]},validate:function(e){return w(1,e)}},"inst-ms":{evaluate:function(){return Date.now()},validate:function(e){return w(0,e)}},"write!":{evaluate:function(e){if(console.log.apply(console,e),e.length>0)return e[e.length-1]}},"debug!":{evaluate:function(e,r){console.error("*** LISPISH DEBUG ***\n\n"+function(e){return a([],e).reverse().reduce((function(e,r,n){return e+"Context "+n+(0===n?" - Import context":1===n?" - Global context":"")+"\n"+function(e){if(0===Object.keys(e).length)return"  <empty>\n";var r=Math.max.apply(Math,Object.keys(e).map((function(e){return e.length})));return Object.entries(e).reduce((function(e,n){return e+"  "+(""+n[0]).padEnd(r+2," ")+function(e){if(N(r=e.value)&&!k(r))return"<builtin function "+e.value.name+">";if(k(e.value))return e.value.name?"<function "+e.value.name+">":"<function λ>";var r;return JSON.stringify(e.value)}(n[1])+"\n"}),"")}(r)+"\n"}),"")}(r))},validate:function(e){return w(0,e)}},boolean:{evaluate:function(e){return!!e[0]},validate:function(e){return w(1,e)}},compare:{evaluate:function(e){return z(e[0],e[1])},validate:function(e){return w(2,e)}},assert:{evaluate:function(e){var r=e[0],n=2===e.length?e[1]:""+r;if(y(n),!r)throw new o(n);return r},validate:function(e){return w({min:1,max:2},e)}},identity:{evaluate:function(e){return e[0]},validate:function(e){return w(1,e)}},partial:{evaluate:function(e){var r,n=e[0],t=e.slice(1);return(r={})[c]=!0,r.fn=n,r.params=t,r},validate:function(e){return w({min:1},e)}}};var xe={object:{evaluate:function(e){for(var r={},n=0;n<e.length;n+=2){var t=e[n],a=e[n+1];y(t),r[t]=a}return r},validate:function(e){return A(e)}},keys:{evaluate:function(e){var r=e[0];return F(r),Object.keys(r)},validate:function(e){return w(1,e)}},vals:{evaluate:function(e){var r=e[0];return F(r),Object.values(r)},validate:function(e){return w(1,e)}},entries:{evaluate:function(e){var r=e[0];return F(r),Object.entries(r)},validate:function(e){return w(1,e)}},dissoc:{evaluate:function(e){var r=e[0],n=e[1];F(r),y(n);var t=r[n];return delete r[n],t},validate:function(e){return w(2,e)}},merge:{evaluate:function(e){var r=e[0],n=e.slice(1);return F(r),n.reduce((function(e,r){return F(r),t(t({},e),r)}),t({},r))},validate:function(e){return w({min:1},e)}}},we={"function?":{evaluate:function(e){return N(e[0])},validate:function(e){return w(1,e)}},"string?":{evaluate:function(e){return"string"==typeof e[0]},validate:function(e){return w(1,e)}},"number?":{evaluate:function(e){return"number"==typeof e[0]},validate:function(e){return w(1,e)}},"integer?":{evaluate:function(e){var r=e[0];return"number"==typeof r&&Number.isInteger(r)},validate:function(e){return w(1,e)}},"boolean?":{evaluate:function(e){return"boolean"==typeof e[0]},validate:function(e){return w(1,e)}},"undefined?":{evaluate:function(e){return void 0===e[0]},validate:function(e){return w(1,e)}},"null?":{evaluate:function(e){return null===e[0]},validate:function(e){return w(1,e)}},"zero?":{evaluate:function(e){var r=e[0];return d(r),0===r},validate:function(e){return w(1,e)}},"pos?":{evaluate:function(e){var r=e[0];return d(r),r>0},validate:function(e){return w(1,e)}},"neg?":{evaluate:function(e){var r=e[0];return d(r),r<0},validate:function(e){return w(1,e)}},"even?":{evaluate:function(e){var r=e[0];return d(r),r%2==0},validate:function(e){return w(1,e)}},"odd?":{evaluate:function(e){var r=e[0];return d(r),Number.isInteger(r)&&r%2!=0},validate:function(e){return w(1,e)}},"array?":{evaluate:function(e){var r=e[0];return Array.isArray(r)},validate:function(e){return w(1,e)}},"collection?":{evaluate:function(e){var r=e[0];return Array.isArray(r)||P(r)},validate:function(e){return w(1,e)}},"object?":{evaluate:function(e){return P(e[0])},validate:function(e){return w(1,e)}},"regexp?":{evaluate:function(e){var r=e[0];return null!==r&&!Array.isArray(r)&&"object"==typeof r&&r instanceof RegExp},validate:function(e){return w(1,e)}},"finite?":{evaluate:function(e){var r=e[0];return M(r),Number.isFinite(r)},validate:function(e){return w(1,e)}},"nan?":{evaluate:function(e){var r=e[0];return M(r),Number.isNaN(r)},validate:function(e){return w(1,e)}},"positive-infinity?":{evaluate:function(e){var r=e[0];return M(r),r===Number.POSITIVE_INFINITY},validate:function(e){return w(1,e)}},"negative-infinity?":{evaluate:function(e){var r=e[0];return M(r),r===Number.NEGATIVE_INFINITY},validate:function(e){return w(1,e)}},"true?":{evaluate:function(e){return!0===e[0]},validate:function(e){return w(1,e)}},"false?":{evaluate:function(e){return!1===e[0]},validate:function(e){return w(1,e)}}},Ae={regexp:{evaluate:function(e){var r=e[0],n=e[1];return y(r),1===e.length?new RegExp(r):(y(n),new RegExp(r,n))},validate:function(e){return w({min:1,max:2},e)}},match:{evaluate:function(e){var r=e[0],n=e[1];x(r),y(n);var t=r.exec(n);if(t)return a([],t)},validate:function(e){return w(2,e)}},replace:{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return y(r),x(n),y(t),r.replace(n,t)},validate:function(e){return w(3,e)}}},Ne={subs:{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return y(r),h(n),void 0===t?r.substring(n):(g(t,n),r.substring(n,t))},validate:function(e){return w({min:2,max:3},e)}},"string-repeat":{evaluate:function(e){var r=e[0],n=e[1];return y(r),h(n),r.repeat(n)},validate:function(e){return w(2,e)}},str:{evaluate:function(e){return e.reduce((function(e,r){return e+(void 0===r?"":null===r?"null":P(r)||Array.isArray(r)?JSON.stringify(r):""+r)}),"")}},"string-to-number":{evaluate:function(e){var r=e[0];y(r);var n=Number(r);if(Number.isNaN(n))throw Error("Could not convert '"+r+"' to a number");return n},validate:function(e){return w(1,e)}},"number-to-string":{evaluate:function(e){var r=e[0],n=e[1];if(d(r),1===e.length)return""+r;if(d(n),2!==n&&8!==n&&10!==n&&16!==n)throw Error('Expected "number-to-string" base argument to be 2, 8, 10 or 16, got: '+n);return 10===n?""+r:(h(r),Number(r).toString(n))},validate:function(e){return w({min:1,max:2},e)}},"lower-case":{evaluate:function(e){var r=e[0];return y(r),r.toLowerCase()},validate:function(e){return w(1,e)}},"upper-case":{evaluate:function(e){var r=e[0];return y(r),r.toUpperCase()},validate:function(e){return w(1,e)}},trim:{evaluate:function(e){var r=e[0];return y(r),r.trim()},validate:function(e){return w(1,e)}},"trim-left":{evaluate:function(e){var r=e[0];return y(r),r.replace(/^\s+/,"")},validate:function(e){return w(1,e)}},"trim-right":{evaluate:function(e){var r=e[0];return y(r),r.replace(/\s+$/,"")},validate:function(e){return w(1,e)}},join:{evaluate:function(e){var r=e[0],n=e[1];return S(r),r.forEach((function(e){return y(e)})),y(n),r.join(n)},validate:function(e){return w(2,e)}},split:{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return y(r),function(e){if(!(e instanceof RegExp||"string"==typeof e))throw TypeError("Expected RegExp or string, got: "+e+' type="'+typeof e+'"')}(n),void 0!==t&&h(t),r.split(n,t)},validate:function(e){return w({min:2,max:3},e)}},"pad-left":{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return y(r),m(n),void 0!==t&&y(t),r.padStart(n,t)},validate:function(e){return w({min:2,max:3},e)}},"pad-right":{evaluate:function(e){var r=e[0],n=e[1],t=e[2];return y(r),m(n),void 0!==t&&y(t),r.padEnd(n,t)},validate:function(e){return w({min:2,max:3},e)}},template:{evaluate:function(e){var r=e[0],n=e.slice(1);y(r);var t=r.split("||||");if(1===t.length)return function(e){if(!Array.isArray(e)||e.some((function(e){return"string"!=typeof e})))throw Error("Expected an array of strings, got "+e)}(n),ke(t[0],n);if(2===t.length){var u=n[0];h(u);var i=a([""+u],n.slice(1));return ke(1===u?t[0]:t[1],i)}throw Error('Invalid template string, only one "||||" separator allowed')},validate:function(e){return w({min:1,max:10},e)}}},je=/\$\$/g;function ke(e,r){for(var n=0;n<9;n+=1){var t=new RegExp("(?<=^|[^$]|\\$\\$)\\$"+(n+1),"g");if(t.test(e)){var a=r[n];y(a),e=e.replace(t,a)}}return e.replace(je,"$")}var Oe=t(t(t(t(t(t(t(t(t(t({},{"bit-shift-left":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),r<<n},validate:function(e){return w(2,e)}},"bit-shift-right":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),r>>n},validate:function(e){return w(2,e)}},"bit-not":{evaluate:function(e){var r=e[0];return m(r),~r},validate:function(e){return w(1,e)}},"bit-and":{evaluate:function(e){var r=e[0],n=e.slice(1);return m(r),n.reduce((function(e,r){return m(r),e&r}),r)},validate:function(e){return w({min:2},e)}},"bit-and-not":{evaluate:function(e){var r=e[0],n=e.slice(1);return m(r),n.reduce((function(e,r){return m(r),e&~r}),r)},validate:function(e){return w({min:2},e)}},"bit-or":{evaluate:function(e){var r=e[0],n=e.slice(1);return m(r),n.reduce((function(e,r){return m(r),e|r}),r)},validate:function(e){return w({min:2},e)}},"bit-xor":{evaluate:function(e){var r=e[0],n=e.slice(1);return m(r),n.reduce((function(e,r){return m(r),e^r}),r)},validate:function(e){return w({min:2},e)}},"bit-flip":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),r^1<<n},validate:function(e){return w(2,e)}},"bit-set":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),r|1<<n},validate:function(e){return w(2,e)}},"bit-clear":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),r&~(1<<n)},validate:function(e){return w(2,e)}},"bit-test":{evaluate:function(e){var r=e[0],n=e[1];return m(r),h(n),!!(r&1<<n)},validate:function(e){return w(2,e)}}}),ce),ve),se),pe),Ee),xe),we),Ae),Ne),Me={def:te,defs:ae,and:{parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"and",params:t[1]}]},evaluate:function(e,r,n){for(var t=n.evaluateAstNode,a=!0,u=0,i=e.params;u<i.length;u++){if(!(a=t(i[u],r)))break}return a}},cond:B,defn:H,defns:X,if:Q,"if-not":ee,fn:Z,let:re,or:{parse:function(e,r,n){var t=(0,n.parseTokens)(e,r);return[t[0]+1,{type:"SpecialExpression",name:"or",params:t[1]}]},evaluate:function(e,r,n){for(var t=n.evaluateAstNode,a=!1,u=0,i=e.params;u<i.length;u++){if(a=t(i[u],r))break}return a}},do:ne,throw:ue,try:ie,when:oe,recur:fe,loop:le};Object.keys(Me).forEach((function(e){if(Oe[e])throw Error("Expression "+e+" is defined as both a normal expression and a special expression")}));var Se={normalExpressions:Oe,specialExpressions:Me},Te=Object.keys(Oe),Ie=Object.keys(Me);function Fe(e,r,n){for(var t,a=[r,n],u=0,i=e.body;u<i.length;u++){var o=i[u];t=Pe(o,a)}return t}var Pe=function(e,r){switch(e.type){case"Number":case"String":return function(e){return e.value}(e);case"Name":return function(e,r){for(var n,t=e.value,a=0,u=r;a<u.length;a++){var i=u[a][t];if(i)return i.value}if(Se.normalExpressions[t])return(n={})[c]=!0,n.builtin=t,n;throw Error("Undefined identifier "+t)}(e,r);case"ReservedName":return function(e){return p(G[e.value],e.value+" is not a reserved name").value}(e);case"NormalExpression":return function(e,r){var n,t=e.params.map((function(e){return Pe(e,r)}));if(function(e){return"string"==typeof e.name}(e)){for(var a=0,u=r;a<u.length;a++){if(V(o=Re(i=null===(n=u[a][e.name])||void 0===n?void 0:n.value,t,r),"value"))return o.value}return function(e,r,n){return(0,p(Se.normalExpressions[e.name],e.name+" is not a function").evaluate)(r,n,{evaluateLispishFunction:Le})}(e,t,r)}var i,o;if(V(o=Re(i=Pe(e.expression,r),t,r),"value"))return o.value;throw Error("Expected function, got "+i)}(e,r);case"SpecialExpression":return function(e,r){return(0,p(Se.specialExpressions[e.name],e.name+" is not a built in special expression").evaluate)(e,r,{evaluateAstNode:Pe,builtin:Se})}(e,r)}};function Re(e,r,n){return N(e)?{value:Le(e,r,n)}:Array.isArray(e)?{value:_e(e,r)}:P(e)?{value:Ce(e,r)}:_(e)?{value:qe(e,r)}:q(e)?{value:Ue(e,r)}:null}var Le=function(e,r,n){var i,o,f;if(!k(e)){if(N(f=e)&&Object.getOwnPropertyDescriptor(f,"fn")){if(V(E=Re(e.fn,a(a([],e.params),r),n),"value"))return E.value;throw Error("Expected function, got "+e.fn)}return p(Oe[e.builtin],e.builtin+" is not a function").evaluate(r,n,{evaluateLispishFunction:Le})}for(var l=e.arguments,c=l.mandatoryArguments.length,v=l.optionalArguments.length,s=l.restArgument?null:c+v;;){var d=t({},e.functionContext);if(r.length<l.mandatoryArguments.length)throw Error("Function "+(null!==(i=e.name)&&void 0!==i?i:"(fn)")+" requires at least "+l.mandatoryArguments.length+" arguments. Got "+r.length);if(null!==s&&r.length>s)throw Error('Function "'+(null!==(o=e.name)&&void 0!==o?o:"λ")+'" requires at most '+s+" arguments. Got "+r.length);for(var h=Math.max(r.length,l.mandatoryArguments.length+l.optionalArguments.length),m=[],g=0;g<h;g+=1)if(g<c){var y=r[g];d[p(l.mandatoryArguments[g],"")]={value:y}}else if(g<c+v){var b=p(l.optionalArguments[g-c],"");y=g<r.length?r[g]:void 0!==b.defaultValue?b.defaultValue:void 0;d[b.name]={value:y}}else m.push(r[g]);l.restArgument&&(d[l.restArgument]={value:m});try{for(var E=void 0,x=0,w=e.body;x<w.length;x++){var A=w[x];E=Pe(A,a([d],n))}return E}catch(e){if(e instanceof u){r=e.params;continue}throw e}}};function Ce(e,r){if(1!==r.length)throw Error("Object as function requires one string parameter");var n=r[0];return y(n),e[n]}function _e(e,r){if(1!==r.length)throw Error("Array as function requires one non negative integer parameter");var n=r[0];return h(n),e[n]}function qe(e,r){if(1!==r.length)throw Error("String as function requires one Obj parameter");var n=r[0];if(P(n))return n[e];if(U(n))return e[n];throw Error("string as function expects Obj or integer parameter, got "+n)}function Ue(e,r){if(m(e),1!==r.length)throw Error("String as function requires one Arr parameter");var n=r[0];return I(n),n[e]}var Ve=function(e,r){for(var n,t,a=p(e[r]),u=[];"paren"!==a.type||")"!==a.value&&"]"!==a.value;)r=(n=Ke(e,r))[0],t=n[1],u.push(t),a=p(e[r]);return[r,u]},$e=function(e,r){var n=p(e[r+=1]);return"name"===n.type&&Se.specialExpressions[n.value]?Je(e,r):We(e,r)},De=/^%([1-9][0-9]?$)/,ze=function(e,r){var n=p(e[r]);if("name"===n.type)return[r+1,{type:"Argument",name:n.value}];if("paren"===n.type&&"("===n.value){if("name"!==(n=p(e[r+=1])).type)throw new f("name",n);var t=n.value,a=Ke(e,r+=1),u=a[0],i=a[1];if("paren"!==(n=p(e[u])).type||")"!==n.value)throw new f(")",n);return[u+1,{type:"Argument",name:t,defaultValue:i}]}if("modifier"===n.type)return[r+1,{type:"Modifier",value:n.value}];throw new f('"(", name or modifier',n)},Be=function(e,r){var n,t=p(e[r]);if("paren"!==t.type||"["!==t.value)throw new f("[",t);t=p(e[r+=1]);for(var a,u=[];"paren"!==t.type||"]"!==t.value;)r=(n=Ge(e,r))[0],a=n[1],u.push(a),t=p(e[r]);return[r+=1,u]};function Ge(e,r){var n,t=p(e[r]);if("name"!==t.type)throw Error("Expected name node in binding, got "+t.type+" value="+t.value);var a=t.value;return t=p(e[r+=1]),[r=(n=Ke(e,r))[0],{type:"Binding",name:a,value:n[1]}]}var We=function(e,r){var n,t,a,u,i;if(r=(n=Ke(e,r))[0],u=n[1],r=(t=Ve(e,r))[0],i=t[1],r+=1,function(e){return"NormalExpression"===e.type||"SpecialExpression"===e.type||"Number"===e.type||"String"===e.type}(u))return[r+1,{type:"NormalExpression",expression:u,params:i}];s(u);var o={type:"NormalExpression",name:u.value,params:i},f=Se.normalExpressions[o.name];return f&&(null===(a=f.validate)||void 0===a||a.call(f,o)),[r,o]},Je=function(e,r){var n=p(e[r]).value;r+=1;var t=p(Se.specialExpressions[n],n+" is not a built in special expression"),a=t.parse,u=t.validate,i=a(e,r,{parseExpression:$e,parseTokens:Ve,parseToken:Ke,parseBindings:Be,parseArgument:ze}),o=i[0],f=i[1];return null==u||u(f),[o,f]},Ke=function(e,r){var n=p(e[r]),t=void 0;switch(n.type){case"number":t=function(e,r){var n=p(e[r]);return[r+1,{type:"Number",value:Number(n.value)}]}(e,r);break;case"string":t=function(e,r){return[r+1,{type:"String",value:p(e[r]).value}]}(e,r);break;case"name":t=function(e,r){return[r+1,{type:"Name",value:p(e[r]).value}]}(e,r);break;case"reservedName":t=function(e,r){return[r+1,{type:"ReservedName",value:p(e[r]).value}]}(e,r);break;case"paren":"("===n.value?t=$e(e,r):"["===n.value?t=function(e,r){for(var n,t,a=p(e[r+=1]),u=[];"paren"!==a.type||"]"!==a.value;)r=(n=Ke(e,r))[0],t=n[1],u.push(t),a=p(e[r]);return[r+=1,{type:"NormalExpression",name:"array",params:u}]}(e,r):"{"===n.value&&(t=function(e,r){for(var n,t,a=p(e[r+=1]),u=[];"paren"!==a.type||"}"!==a.value;)r=(n=Ke(e,r))[0],t=n[1],u.push(t),a=p(e[r]);r+=1;var i={type:"NormalExpression",name:"object",params:u};return A(i),[r,i]}(e,r));break;case"regexpShorthand":t=function(e,r){return[r+1,{type:"NormalExpression",name:"regexp",params:[{type:"String",value:p(e[r]).value}]}]}(e,r);break;case"fnShorthand":t=function(e,r){for(var n=We(e,r+=2),t=n[0],a=n[1],u=0,i=r+1;i<t-1;i+=1){var o=p(e[i]);if("name"===o.type){var f=De.exec(o.value);if(f&&(u=Math.max(u,Number(f[1])))>20)throw Error("Can't specify more than 20 arguments")}if("fnShorthand"===o.type)throw Error("Nested shortcut functions are not allowed")}for(var l=[],c=1;c<=u;c+=1)l.push("%"+c);return[t,{type:"SpecialExpression",name:"fn",params:[],arguments:{bindings:[],mandatoryArguments:l,optionalArguments:[]},body:[a]}]}(e,r)}if(!t)throw SyntaxError("Unrecognized token: "+n.type+" value="+n.value);return t};var Ye=/[%0-9a-zA-Z_^?=!$%<>.+*/-]/,He=/\s|,/,Xe=function(e,r){if('"'!==e[r])return[0,void 0];for(var n="",t=1,a=e[r+t],u=!1;'"'!==a||u;){if(void 0===a)throw new SyntaxError("Unclosed string at position "+r);u?(u=!1,'"'===a||"\\"===a||(n+="\\"),n+=a):"\\"===a?u=!0:n+=a,a=e[r+(t+=1)]}return[t+1,{type:"string",value:n}]},Ze=/\s|[)\]},]/,Qe=/[0-9]/,er=/[0-7]/,rr=/[0-9a-fA-F]/,nr=/[0-1]/,tr=/[0-9.-]/;function ar(e,r,n,t){return r===n[t]?[1,{type:e,value:r}]:[0,void 0]}var ur=[function(e,r){if(";"===e[r]){for(var n=1;"\n"!==e[r+n]&&r+n<e.length;)n+=1;return"\n"===e[r+n]&&r+n<e.length&&(n+=1),[n,void 0]}return[0,void 0]},function(e,r){var n;return He.test(null!==(n=e[r])&&void 0!==n?n:"")?[1,void 0]:[0,void 0]},function(e,r){return ar("paren","(",e,r)},function(e,r){return ar("paren",")",e,r)},function(e,r){return ar("paren","[",e,r)},function(e,r){return ar("paren","]",e,r)},function(e,r){return ar("paren","{",e,r)},function(e,r){return ar("paren","}",e,r)},Xe,function(e,r){var n="decimal",t=e[r];if(void 0===t)return[0,void 0];var a,u="."===t;if(!tr.test(t))return[0,void 0];for(a=r+1;a<e.length;a+=1){var i=p(e[a]);if(Ze.test(i))break;if(a===r+1&&"0"===t){if("b"===i||"B"===i){n="binary";continue}if("o"===i||"O"===i){n="octal";continue}if("x"===i||"X"===i){n="hex";continue}}if("decimal"===n&&u){if(!Qe.test(i))return[0,void 0]}else if("binary"===n){if(!nr.test(i))return[0,void 0]}else if("octal"===n){if(!er.test(i))return[0,void 0]}else if("hex"===n){if(!rr.test(i))return[0,void 0]}else{if("."===i){u=!0;continue}if(!Qe.test(i))return[0,void 0]}}var o=a-r,f=e.substring(r,a);return"decimal"!==n&&o<=2||"."===f||"-"===f?[0,void 0]:[o,{type:"number",value:f}]},function(e,r){for(var n=0,t=Object.keys(G);n<t.length;n++){var a=t[n],u=a.length,i=e[r+u];if((!i||!Ye.test(i))&&e.substr(r,u)===a)return[u,{type:"reservedName",value:a}]}return[0,void 0]},function(e,r){return function(e,r,n,t){var a=n[t],u=0,i="";if(!a||!r.test(a))return[0,void 0];for(;a&&r.test(a);)i+=a,a=n[t+(u+=1)];return[u,{type:e,value:i}]}("name",Ye,e,r)},function(e,r){return"&rest"===e.substr(r,5)?[5,{type:"modifier",value:"&rest"}]:"&opt"===e.substr(r,4)?[4,{type:"modifier",value:"&opt"}]:"&bind"===e.substr(r,5)?[5,{type:"modifier",value:"&bind"}]:[0,void 0]},function(e,r){if("#"!==e[r])return[0,void 0];var n=Xe(e,r+1),t=n[0],a=n[1];return a?[t+1,{type:"regexpShorthand",value:a.value}]:[0,void 0]},function(e,r){return"#("!==e.slice(r,r+2)?[0,void 0]:[1,{type:"fnShorthand",value:"#"}]}];var ir=function(){function e(){this.importScope={}}return e.prototype.tokenize=function(e){return function(e){for(var r=[],n=0,t=!1;n<e.length;){t=!1;for(var a=0,u=ur;a<u.length;a++){var i=(0,u[a])(e,n),o=i[0],f=i[1];if(o>0&&(t=!0,n+=o,f)){r.push(f);break}}if(!t)throw new SyntaxError("Unrecognized character at position "+n+": '"+e[n]+"'")}return r}(e)},e.prototype.parse=function(e){return function(e){for(var r,n,t={type:"Program",body:[]},a=0;a<e.length;)a=(r=Ke(e,a))[0],n=r[1],t.body.push(n);return t}(e)},e.prototype.evaluate=function(e,r){void 0===r&&(r={});var n=r.globalContext||{};return r.vars&&Object.entries(r.vars).forEach((function(e){var r=e[0],t=e[1];n[r]={value:t}})),Fe(e,n,this.importScope)},e.prototype.run=function(e,r){var n=this.tokenize(e),t=this.parse(n);return this.evaluate(t,r)},e.prototype.import=function(e){var r=this.tokenize(e),n={};Fe(this.parse(r),n,{});for(var t=Object.keys(this.importScope),a=0,u=Object.keys(n);a<u.length;a++){var i=u[a];if(t.includes(i))throw Error('Import faild, imported function/variable already exists: "'+i+'"');J(i,[{},{}],Se)}Object.assign(this.importScope,n)},e}();return e.Lispish=ir,e.isLispishFunction=N,e.normalExpressionKeys=Te,e.reservedNames=W,e.specialExpressionKeys=Ie,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=lispish.iife.js.map
